---
# https://taskfile.dev/usage/
# https://github.com/go-task/task

version: "3"

set: [pipefail]
# shopt: [globstar]

vars:
  PROJECT_DIR:
    sh: git rev-parse --show-toplevel
  GIT_COMMIT:
    sh: git log -n 1 --format=%h
  USER_HOME_DIR:
    sh: echo $HOME
  USER_ID:
    sh: id -u
  GROUP_ID:
    sh: id -g
  # Check if running as root, omit `sudo` from make targets if that is the case.
  DO_SUDO:
    sh: if [ "$UID" -ne 0 ]; then echo "sudo"; fi
  # Ansible vars are inherited in many taskfiles, so leave them here in main taskfile.
  ANSIBLE_DIR: "{{.PROJECT_DIR}}/provision/ansible"
  ANSIBLE_PLAYBOOK_DIR: "{{.ANSIBLE_DIR}}/playbooks"
  ANSIBLE_INVENTORY_DIR: "{{.ANSIBLE_DIR}}/inventory"
  ANSIBLE_INVENTORY_FILENAME: "generated.yml"
  ANSIBLE_INVENTORY_CMD: "-i {{.ANSIBLE_INVENTORY_DIR}}/{{.ANSIBLE_INVENTORY_FILENAME}}"
  ANSIBLE_CMD: "doppler run -- ansible {{.ANSIBLE_INVENTORY_CMD}}"
  ANSIBLE_PLAYBOOK_CMD: "doppler run -- ansible-playbook {{.ANSIBLE_INVENTORY_CMD}}"
  K3S_ANSIBLE_DIR: "{{.PROJECT_DIR}}/provision/k3s-ansible"
  K3S_ANSIBLE_INVENTORY_DIR: "{{.K3S_ANSIBLE_DIR}}/inventory"
  K3S_ANSIBLE_INVENTORY_FILENAME: "generated.ini"
  K3S_ANSIBLE_INVENTORY_CMD: "-i {{.K3S_ANSIBLE_INVENTORY_DIR}}/{{.K3S_ANSIBLE_INVENTORY_FILENAME}}"
  K3S_ANSIBLE_CMD: "doppler run -- ansible {{.K3S_ANSIBLE_INVENTORY_CMD}}"
  K3S_ANSIBLE_PLAYBOOK_CMD: "doppler run -- ansible-playbook {{.K3S_ANSIBLE_INVENTORY_CMD}}"

env:
  KUBECONFIG: "{{.USER_HOME_DIR}}/.kube/config"
  PATH: "{{.PATH}}:{{.PROJECT_DIR}}/bin"  # add project bin to path
  PROJECT_DIR: "{{.PROJECT_DIR}}"
  ANSIBLE_CONFIG: "{{.ANSIBLE_DIR}}/ansible.cfg"

includes:
  ansible:
    taskfile: .taskfiles/Ansible.yml
    aliases: ["a", "ans"]
  docker:
    taskfile: .taskfiles/Docker.yml
    aliases: ["dc"]
  doppler:
    taskfile: .taskfiles/Doppler.yml
    aliases: ["dp"]
  flux:
    taskfile: .taskfiles/Flux.yml
    aliases: ["f"]
  internal:
    taskfile: .taskfiles/internal.yml
    internal: true
  k3s:
    taskfile: .taskfiles/K3s.yml
    aliases: ["k"]
  lxc:
    taskfile: .taskfiles/Lxc.yml
    aliases: ["l"]
  # minikube: .taskfiles/Minikube.yml
  molecule:
    taskfile: .taskfiles/Molecule.yml
    aliases: ["m"]
  precommit:
    taskfile: .taskfiles/Precommit.yml
    aliases: ["pc"]
  proxmox:
    taskfile: .taskfiles/Proxmox.yml
    aliases: ["p"]
  setup:
    taskfile: .taskfiles/Setup.yml
    aliases: ["s"]
  terraform:
    taskfile: .taskfiles/Terraform.yml
    aliases: ["t", "tf"]
  windows:
    taskfile: .taskfiles/Windows.yml
    aliases: ["win"]
  workstation:
    taskfile: .taskfiles/Workstation.yml
    aliases: ["ws"]
  wsl: .taskfiles/Wsl.yml

tasks:

  all:
    desc: My current entire automation for k3s stack with LXC containers on proxmox w/ flux + tf + ansible etc.
    cmds:
      - task: k3s:main
      - task: terraform:bootstrap
      - task: flux:install
      - echo "Sleeping... Seriously, let flux do it's thang.."
      - sleep 120
      - task: terraform:init
      - task: terraform:apply
      - task: internal:deploy-doppler-secrets-to-k8s
      # - task: terraform:post-tasks
      # - task: terraform:proxmox-init
      # - task: terraform:proxmox-plan
      # - task: terraform:proxmox-apply

#---------#
# Linters #
#---------#

  # check lint:
  #   desc: ðŸ”Ž Run all tests, Linters & formatters (currently will not fix but sets exit code on error)
  #   cmds:
  #     - echo '**** LGTM! ****'

  # _start-check:
  #   desc: Diagnostic output; useful when run in a git hook
  #   cmds:
  #     - echo 'Running "make check / make lint"'

  # yamllint:
  #   desc: Currently the only one.. will add more targets in the future.
  #   cmds:
  #     - yamllint -f parsable .
